import{createSign as e,sign as t,timingSafeEqual as r,createHmac as n,createVerify as o,constants as i,verify as a,createHash as s,createSecretKey as c,createPublicKey as u}from"crypto";import l from"buffer";import f from"just-safe-set";class h extends Error{constructor(e,t,r){if(super(t),Error.captureStackTrace(this,this.constructor),this.code=e,r)for(const e in r)this[e]=r[e]}}function p({complete:e,checkTyp:t},r){if(r instanceof Buffer)r=r.toString("utf-8");else if("string"!=typeof r)throw new h(h.codes.invalidType,"The token must be a string or a buffer.");const n=r.indexOf("."),o=r.lastIndexOf(".");if(-1===n||n>=o)throw new h(h.codes.malformed,"The token is malformed.");let i=!1;try{const a=JSON.parse(Buffer.from(r.slice(0,n),"base64").toString("utf-8"));if(t&&a.typ!==t)throw new h(h.codes.invalidType,`The type must be "${t}".`,{header:a});i=!0;let s=Buffer.from(r.slice(n+1,o),"base64").toString("utf-8");if(s=JSON.parse(s),!s||"object"!=typeof s)throw new h(h.codes.invalidPayload,"The payload must be an object",{payload:s});return e?{header:a,payload:s,signature:r.slice(o+1),input:r.slice(0,o)}:s}catch(e){throw h.wrap(e,h.codes.malformed,`The token ${i?"payload":"header"} is not a valid base64url serialized JSON.`)}}function d(e={}){const t=e.complete||!1,r=e.checkTyp;return p.bind(null,{complete:t,checkTyp:r})}h.codes={invalidType:"FAST_JWT_INVALID_TYPE",invalidOption:"FAST_JWT_INVALID_OPTION",invalidAlgorithm:"FAST_JWT_INVALID_ALGORITHM",invalidClaimType:"FAST_JWT_INVALID_CLAIM_TYPE",invalidClaimValue:"FAST_JWT_INVALID_CLAIM_VALUE",invalidKey:"FAST_JWT_INVALID_KEY",invalidSignature:"FAST_JWT_INVALID_SIGNATURE",invalidPayload:"FAST_JWT_INVALID_PAYLOAD",malformed:"FAST_JWT_MALFORMED",inactive:"FAST_JWT_INACTIVE",expired:"FAST_JWT_EXPIRED",missingKey:"FAST_JWT_MISSING_KEY",keyFetchingError:"FAST_JWT_KEY_FETCHING_ERROR",signError:"FAST_JWT_SIGN_ERROR",verifyError:"FAST_JWT_VERIFY_ERROR"},h.wrap=function(e,t,r){return e instanceof h?e:new h(t,r,{originalError:e})};var y,m,w=(function(e,t){
/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
var r=l.Buffer;function n(e,t){for(var r in e)t[r]=e[r]}function o(e,t,n){return r(e,t,n)}r.from&&r.alloc&&r.allocUnsafe&&r.allocUnsafeSlow?e.exports=l:(n(l,t),t.Buffer=o),o.prototype=Object.create(r.prototype),n(r,o),o.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return r(e,t,n)},o.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var o=r(e);return void 0!==t?"string"==typeof n?o.fill(t,n):o.fill(t):o.fill(0),o},o.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r(e)},o.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return l.SlowBuffer(e)}}(m={path:y,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&m.path)}},m.exports),m.exports);function g(e){return(e/8|0)+(e%8==0?0:1)}var b={ES256:g(256),ES384:g(384),ES512:g(521)};var v=function(e){var t=b[e];if(t)return t;throw new Error('Unknown algorithm "'+e+'"')},A=w.Buffer;function T(e){if(A.isBuffer(e))return e;if("string"==typeof e)return A.from(e,"base64");throw new TypeError("ECDSA signature must be a Base64 string or a Buffer")}function E(e,t,r){for(var n=0;t+n<r&&0===e[t+n];)++n;return e[t+n]>=128&&--n,n}var S={derToJose:function(e,t){e=T(e);var r=v(t),n=r+1,o=e.length,i=0;if(48!==e[i++])throw new Error('Could not find expected "seq"');var a=e[i++];if(129===a&&(a=e[i++]),o-i<a)throw new Error('"seq" specified length of "'+a+'", only "'+(o-i)+'" remaining');if(2!==e[i++])throw new Error('Could not find expected "int" for "r"');var s=e[i++];if(o-i-2<s)throw new Error('"r" specified length of "'+s+'", only "'+(o-i-2)+'" available');if(n<s)throw new Error('"r" specified length of "'+s+'", max of "'+n+'" is acceptable');var c=i;if(i+=s,2!==e[i++])throw new Error('Could not find expected "int" for "s"');var u=e[i++];if(o-i!==u)throw new Error('"s" specified length of "'+u+'", expected "'+(o-i)+'"');if(n<u)throw new Error('"s" specified length of "'+u+'", max of "'+n+'" is acceptable');var l=i;if((i+=u)!==o)throw new Error('Expected to consume entire buffer, but "'+(o-i)+'" bytes remain');var f=r-s,h=r-u,p=A.allocUnsafe(f+s+h+u);for(i=0;i<f;++i)p[i]=0;e.copy(p,i,c+Math.max(-f,0),c+s);for(var d=i=r;i<d+h;++i)p[i]=0;return e.copy(p,i,l+Math.max(-h,0),l+u),p=(p=p.toString("base64")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},joseToDer:function(e,t){e=T(e);var r=v(t),n=e.length;if(n!==2*r)throw new TypeError('"'+t+'" signatures must be "'+2*r+'" bytes, saw "'+n+'"');var o=E(e,0,r),i=E(e,r,e.length),a=r-o,s=r-i,c=2+a+1+1+s,u=c<128,l=A.allocUnsafe((u?2:3)+c),f=0;return l[f++]=48,u?l[f++]=c:(l[f++]=129,l[f++]=255&c),l[f++]=2,l[f++]=a,o<0?(l[f++]=0,f+=e.copy(l,f,0,r)):f+=e.copy(l,f,o,r),l[f++]=2,l[f++]=s,i<0?(l[f++]=0,e.copy(l,f,r)):e.copy(l,f,r+i),l}};function k(e){Object.defineProperty(this,"_next",{writable:!1,enumerable:!1,value:e}),this.done=!1}k.prototype.next=function(){if(this.done)return{done:!0};var e=this._next();return e.done&&(this.done=!0),e},"undefined"!=typeof Symbol&&(k.prototype[Symbol.iterator]=function(){return this}),k.of=function(){var e=arguments,t=e.length,r=0;return new k((function(){return r>=t?{done:!0}:{done:!1,value:e[r++]}}))},k.empty=function(){var e=new k(null);return e.done=!0,e},k.is=function(e){return e instanceof k||"object"==typeof e&&null!==e&&"function"==typeof e.next};var _=k,x="undefined"!=typeof ArrayBuffer,I="undefined"!=typeof Symbol;function P(e,t){var r,n,o,i,a;if(!e)throw new Error("obliterator/forEach: invalid iterable.");if("function"!=typeof t)throw new Error("obliterator/forEach: expecting a callback.");if(Array.isArray(e)||x&&ArrayBuffer.isView(e)||"string"==typeof e||"[object Arguments]"===e.toString())for(o=0,i=e.length;o<i;o++)t(e[o],o);else if("function"!=typeof e.forEach)if(I&&Symbol.iterator in e&&"function"!=typeof e.next&&(e=e[Symbol.iterator]()),"function"!=typeof e.next)for(n in e)e.hasOwnProperty(n)&&t(e[n],n);else for(r=e,o=0;!0!==(a=r.next()).done;)t(a.value,o),o++;else e.forEach(t)}P.forEachWithNullKeys=function(e,t){var r,n,o,i,a;if(!e)throw new Error("obliterator/forEachWithNullKeys: invalid iterable.");if("function"!=typeof t)throw new Error("obliterator/forEachWithNullKeys: expecting a callback.");if(Array.isArray(e)||x&&ArrayBuffer.isView(e)||"string"==typeof e||"[object Arguments]"===e.toString())for(o=0,i=e.length;o<i;o++)t(e[o],null);else if(e instanceof Set)e.forEach((function(e){t(e,null)}));else if("function"!=typeof e.forEach)if(I&&Symbol.iterator in e&&"function"!=typeof e.next&&(e=e[Symbol.iterator]()),"function"!=typeof e.next)for(n in e)e.hasOwnProperty(n)&&t(e[n],n);else for(r=e,o=0;!0!==(a=r.next()).done;)t(a.value,null),o++;else e.forEach(t)};var N,L=P,j=(function(e,t){var r=Math.pow(2,8)-1,n=Math.pow(2,16)-1,o=Math.pow(2,32)-1,i=Math.pow(2,7)-1,a=Math.pow(2,15)-1,s=Math.pow(2,31)-1;t.getPointerArray=function(e){var t=e-1;return t<=r?Uint8Array:t<=n?Uint16Array:t<=o?Uint32Array:Float64Array},t.getSignedPointerArray=function(e){var t=e-1;return t<=i?Int8Array:t<=a?Int16Array:t<=s?Int32Array:Float64Array},t.getNumberType=function(e){return e===(0|e)?-1===Math.sign(e)?e<=127&&e>=-128?Int8Array:e<=32767&&e>=-32768?Int16Array:Int32Array:e<=255?Uint8Array:e<=65535?Uint16Array:Uint32Array:Float64Array};var c={Uint8Array:1,Int8Array:2,Uint16Array:3,Int16Array:4,Uint32Array:5,Int32Array:6,Float32Array:7,Float64Array:8};t.getMinimalRepresentation=function(e,r){var n,o,i,a,s,u=null,l=0;for(a=0,s=e.length;a<s;a++)i=r?r(e[a]):e[a],o=t.getNumberType(i),(n=c[o.name])>l&&(l=n,u=o);return u},t.isTypedArray=function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView(e)},t.concat=function(){var e,t,r,n=0;for(e=0,r=arguments.length;e<r;e++)n+=arguments[e].length;var o=new arguments[0].constructor(n);for(e=0,t=0;e<r;e++)o.set(arguments[e],t),t+=arguments[e].length;return o},t.indices=function(e){for(var r=new(t.getPointerArray(e))(e),n=0;n<e;n++)r[n]=n;return r}}(N={path:undefined,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&N.path)}},N.exports),N.exports),C=j.isTypedArray;function B(e){return"number"==typeof e.length?e.length:"number"==typeof e.size?e.size:void 0}var O={isArrayLike:function(e){return Array.isArray(e)||C(e)},guessLength:B,toArray:function(e){var t=B(e),r="number"==typeof t?new Array(t):[],n=0;return L(e,(function(e){r[n++]=e})),r}};function V(e,t,r){if(arguments.length<2&&(r=e,e=null,t=null),this.capacity=r,"number"!=typeof this.capacity||this.capacity<=0)throw new Error("mnemonist/lru-cache: capacity should be positive number.");var n=j.getPointerArray(r);this.forward=new n(r),this.backward=new n(r),this.K="function"==typeof e?new e(r):new Array(r),this.V="function"==typeof t?new t(r):new Array(r),this.size=0,this.head=0,this.tail=0,this.items={}}V.prototype.clear=function(){this.size=0,this.head=0,this.tail=0,this.items={}},V.prototype.splayOnTop=function(e){var t=this.head;if(this.head===e)return this;var r=this.backward[e],n=this.forward[e];return this.tail===e?this.tail=r:this.backward[n]=r,this.forward[r]=n,this.backward[t]=e,this.head=e,this.forward[e]=t,this},V.prototype.set=function(e,t){var r=this.items[e];if(void 0!==r)return this.splayOnTop(r),void(this.V[r]=t);this.size<this.capacity?r=this.size++:(r=this.tail,this.tail=this.backward[r],delete this.items[this.K[r]]),this.items[e]=r,this.K[r]=e,this.V[r]=t,this.forward[r]=this.head,this.backward[this.head]=r,this.head=r},V.prototype.setpop=function(e,t){var r=null,n=null,o=this.items[e];return void 0!==o?(this.splayOnTop(o),r=this.V[o],this.V[o]=t,{evicted:!1,key:e,value:r}):(this.size<this.capacity?o=this.size++:(o=this.tail,this.tail=this.backward[o],r=this.V[o],n=this.K[o],delete this.items[this.K[o]]),this.items[e]=o,this.K[o]=e,this.V[o]=t,this.forward[o]=this.head,this.backward[this.head]=o,this.head=o,n?{evicted:!0,key:n,value:r}:null)},V.prototype.has=function(e){return e in this.items},V.prototype.get=function(e){var t=this.items[e];if(void 0!==t)return this.splayOnTop(t),this.V[t]},V.prototype.peek=function(e){var t=this.items[e];if(void 0!==t)return this.V[t]},V.prototype.forEach=function(e,t){t=arguments.length>1?t:this;for(var r=0,n=this.size,o=this.head,i=this.K,a=this.V,s=this.forward;r<n;)e.call(t,a[o],i[o],this),o=s[o],r++},V.prototype.keys=function(){var e=0,t=this.size,r=this.head,n=this.K,o=this.forward;return new _((function(){if(e>=t)return{done:!0};var i=n[r];return++e<t&&(r=o[r]),{done:!1,value:i}}))},V.prototype.values=function(){var e=0,t=this.size,r=this.head,n=this.V,o=this.forward;return new _((function(){if(e>=t)return{done:!0};var i=n[r];return++e<t&&(r=o[r]),{done:!1,value:i}}))},V.prototype.entries=function(){var e=0,t=this.size,r=this.head,n=this.K,o=this.V,i=this.forward;return new _((function(){if(e>=t)return{done:!0};var a=n[r],s=o[r];return++e<t&&(r=i[r]),{done:!1,value:[a,s]}}))},"undefined"!=typeof Symbol&&(V.prototype[Symbol.iterator]=V.prototype.entries),V.prototype.inspect=function(){for(var e,t=new Map,r=this.entries();!(e=r.next()).done;)t.set(e.value[0],e.value[1]);return Object.defineProperty(t,"constructor",{value:V,enumerable:!1}),t},"undefined"!=typeof Symbol&&(V.prototype[Symbol.for("nodejs.util.inspect.custom")]=V.prototype.inspect),V.from=function(e,t,r,n){if(arguments.length<2){if("number"!=typeof(n=O.guessLength(e)))throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else 2===arguments.length&&(n=t,t=null,r=null);var o=new V(t,r,n);return L(e,(function(e,t){o.set(t,e)})),o};var K=V;const R=require("asn1.js").define,{RSA_PKCS1_PSS_PADDING:D,RSA_PSS_SALTLEN_DIGEST:F,RSA_PKCS1_PADDING:U,RSA_PSS_SALTLEN_MAX_SIGN:M,RSA_PSS_SALTLEN_AUTO:q}=i;let J=t;const W=a,z="function"==typeof J,$=/^-----BEGIN(?: (RSA|EC))? PRIVATE KEY-----/,G=(new K(1e3),new K(1e3)),Y=["HS256","HS384","HS512"],H=["RS256","RS384","RS512","PS256","PS384","PS512"],X={"1.2.840.10045.3.1.7":{bits:"256",names:["P-256","prime256v1"]},"1.3.132.0.10":{bits:"256",names:["secp256k1"]},"1.3.132.0.34":{bits:"384",names:["P-384","secp384r1"]},"1.3.132.0.35":{bits:"512",names:["P-521","secp521r1"]}};z||(J=function(t,r,n){if(void 0===t)throw new h(h.codes.signError,"EdDSA algorithms are not supported by your Node.js version.");return e(t).update(r).sign(n)});R("PrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("algorithm").seq().obj(this.key("algorithm").objid(),this.key("parameters").optional().objid()))}));const Q=R("PublicKey",(function(){this.seq().obj(this.key("algorithm").seq().obj(this.key("algorithm").objid(),this.key("parameters").optional().objid()))}));R("ECPrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("privateKey").octstr(),this.key("parameters").explicit(0).optional().choice({namedCurve:this.objid()}))}));function Z(e,t,r,n){return e.set(t,[r,n]),r||n}function ee(e){if(!e)return"none";const[t,r]=G.get(e)||[];if(t)return t;if(r)throw r;try{if(e instanceof Buffer)e=e.toString("utf-8");else if("string"!=typeof e)throw new h(h.codes.invalidKey,"The public key must be a string or a buffer.");return Z(G,e,function(e){if(e.match($))throw new h(h.codes.invalidKey,"Private keys are not supported for verifying.");if(!e.includes("-----BEGIN PUBLIC KEY-----"))return Y;const t=Q.decode(e,"pem",{label:"PUBLIC KEY"}),r=t.algorithm.algorithm.join(".");let n;switch(r){case"1.2.840.113549.1.1.1":return H;case"1.2.840.10045.2.1":n=t.algorithm.parameters.join(".");break;case"1.3.101.112":case"1.3.101.113":return["EdDSA"];default:throw new h(h.codes.invalidKey,`Unsupported PEM PCKS8 public key with OID ${r}.`)}const o=X[n];if(!o)throw new h(h.codes.invalidKey,`Unsupported EC public key with curve ${n}.`);return["ES"+o.bits]}(e))}catch(t){throw Z(G,e,null,h.wrap(t,h.codes.invalidKey,"Unsupported PEM public key."))}}const te=/"alg"\s*:\s*"[HERP]S(256|384)"/m,re=/"alg"\s*:\s*"EdDSA"/m,ne=/"crv"\s*:\s*"Ed448"/m;function oe(e){const t=e.split(".",1)[0],r=Buffer.from(t,"base64").toString("utf-8");let n=null;if(r.match(re)&&r.match(ne))n=s("shake256",{outputLength:114});else{const e=r.match(te);n=s("sha"+(e?e[1]:"512"))}return n.update(e).digest("hex")}function ie(e,t){const r=e[0].slice(0,2),n=t[0].slice(0,2);let o=!0;if("RS"===r||"PS"===r?o="RS"===n:"ES"!==r&&"Ed"!==r||(o=r===n),!o)throw new h(h.codes.invalidKey,`Invalid public key provided for algorithms ${e.join(", ")}.`)}function ae(e,t){return"string"==typeof e&&(e=Buffer.from(e,"utf-8")),z&&(e=t?c(e):u(e)),e}function se(e){return Array.isArray(e)||(e=[e]),e.map(e=>e&&"function"==typeof e.test?e:new RegExp(e.toString()))}function ce(e){const t=parseInt(!0===e?1e3:e,10);return t>0?new K(t):null}function ue({cache:e,token:t,cacheTTL:r,payload:n,ignoreExpiration:o,ignoreNotBefore:i,maxAge:a,clockTimestamp:s,clockTolerance:c},u){if(!e)return u;const l=[u,0,0];n&&"number"==typeof n.iat&&(l[1]=i||"number"!=typeof n.nbf?0:1e3*n.nbf,o||("number"==typeof n.exp?l[2]=1e3*n.exp:a&&(l[2]=1e3*n.iat+a)));const f=(s||Date.now())+c+r;return l[2]=0===l[2]?f:Math.min(l[2],f),e.set(oe(t),l),u}function le(e,t,r,n){const o=r?`The ${t} claim must be a ${n} or an array of ${n}s.`:`The ${t} claim must be a ${n}.`;if(e.map(e=>typeof e).some(e=>e!==n))throw new h(h.codes.invalidClaimType,o)}function fe(e,t,r,n){const o=n?`None of ${t} claim values is allowed.`:`The ${t} claim value is not allowed.`;if(!e.some(e=>r.some(t=>t.test(e))))throw new h(h.codes.invalidClaimValue,o)}function he(e,t,r,n,o,i){const a=1e3*e+(t||0);if(!(n?r>=a:r<=a))throw new h(h.codes[o],`The token ${i} at ${new Date(a).toISOString()}.`)}function pe(e,{input:t,header:i,payload:a,signature:s},{validators:c,allowedAlgorithms:u,checkTyp:l,clockTimestamp:f,clockTolerance:p}){const d=e instanceof Buffer?e.length:!!e;if(d&&!s)throw new h(h.codes.missingSignature,"The token signature is missing.");if(!d&&s)throw new h(h.codes.missingKey,"The key option is missing.");if(function(e,t,i,a,s){if(!s.includes(t.alg))throw new h(h.codes.invalidAlgorithm,"The token algorithm is invalid.");if(i&&!function(e,t,i,a){try{const s=e.slice(0,2),c="SHA"+e.slice(2);if(a=Buffer.from(a,"base64"),"HS"===s)try{return r(n(c,t).update(i).digest(),a)}catch(e){return!1}else if("Ed"===s){if("function"==typeof W)return W(void 0,Buffer.from(i,"utf-8"),t,a);throw new h(h.codes.signError,"EdDSA algorithms are not supported by your Node.js version.")}const u={key:t,padding:U,saltLength:q};return"PS"===s?(u.padding=D,u.saltLength=F):"ES"===s&&(a=S.joseToDer(a,e)),o("RSA-"+c).update(i).verify(u,a)}catch(e){throw new h(h.codes.verifyError,"Cannot verify the signature.",{originalError:e})}}(t.alg,a,e,i))throw new h(h.codes.invalidSignature,"The token signature is invalid.")}(t,i,s,e,u),l&&("string"!=typeof i.typ||l!==i.typ.toLowerCase().replace(/^application\//,"")))throw new h(h.codes.invalidType,"Invalid typ.");const y=(f||Date.now())+p;for(const e of c){const{type:t,claim:r,allowed:n,array:o,modifier:i,greater:s,errorCode:c,errorVerb:u}=e,l=a[r],f=Array.isArray(l),h=f?l:[l];r in a&&(le(h,r,o,"date"===t?"number":"string"),"date"===t?he(l,i,y,s,c,u):fe(h,r,n,f))}}function de({key:e,allowedAlgorithms:t,complete:r,cacheTTL:n,checkTyp:o,clockTimestamp:i,clockTolerance:a,ignoreExpiration:s,ignoreNotBefore:c,maxAge:u,isAsync:l,validators:f,decode:p,cache:d},y,m){const[w,g]=l?function(e){if("function"==typeof e)return[e];let t,r;return[function(e,n){return e?r(e):t(n)},new Promise((e,n)=>{t=e,r=n})]}(m):[],b={cache:d,token:y,cacheTTL:n,payload:void 0,ignoreExpiration:s,ignoreNotBefore:c,maxAge:u,clockTimestamp:i,clockTolerance:a};if(d){const[e,t,r]=d.get(oe(y))||[void 0,0,0],n=(i||Date.now())+a;if(void 0!==e&&(0===t||n>t)&&(0===r||n<=r))return function(e,t,r){if(e instanceof h){if(!t)throw e;t(e)}else{if(!t)return e;t(null,e)}return r}(e,w,g)}let v;try{v=p(y)}catch(e){if(w)return w(e),g;throw e}const{header:A,payload:T,signature:E}=v;b.payload=T;const S={validators:f,allowedAlgorithms:t,checkTyp:o,clockTimestamp:i,clockTolerance:a};if(!w)try{return pe(e,v,S),ue(b,r?{header:A,payload:T,signature:E}:T)}catch(e){throw ue(b,e)}return function(e,t,r){const n=e(t,r);n&&"function"==typeof n.then&&n.then(e=>{process.nextTick(()=>r(null,e))}).catch(r)}(e,A,(e,n)=>{if(e)return w(ue(b,h.wrap(e,h.codes.keyFetchingError,"Cannot fetch key.")));if("string"==typeof n)n=Buffer.from(n,"utf-8");else if(!(n instanceof Buffer))return w(ue(b,new h(h.codes.keyFetchingError,"The key returned from the callback must be a string or a buffer containing a secret or a public key.")));try{const e=ee(n);S.allowedAlgorithms.length?ie(t,e):S.allowedAlgorithms=e,pe(n=ae(n,e[0]===Y[0]),v,S)}catch(e){return w(ue(b,e))}w(null,ue(b,r?{header:A,payload:T,signature:E}:T))}),g}Array.from(new Set([...Y,"ES256","ES384","ES512",...H,"EdDSA","none"])).join(", ");class ye extends Error{constructor(e,t){super(t),this.code=e,this.name=this.constructor.name,this.code=e}}class me extends ye{constructor(e){super(401,"Revoked token, reason: "+e),this.reason=e,this.reason=e}}class we extends ye{constructor(e){super(401,"Invalid token, reason: "+e),this.reason=e,this.reason=e}}class ge extends we{constructor(e,t){super(void 0!==e?"token must be of type '"+e+(void 0!==t?.typ?`' but is of type '${t.typ}.`:"."):"token must be a string or a buffer."),this.typ=e}}class be extends we{constructor(){super("token is malformed.")}}class ve extends we{constructor(){super("token payload must be an object.")}}class Ae extends we{constructor(){super("token signature is invalid.")}}class Te extends we{constructor(e){super(e.toLowerCase()),this.reason=e}}class Ee extends ye{constructor(){super(401,"Credentials bad scheme")}}class Se extends ye{constructor(){super(401,"Credentials bad format")}}class ke extends ye{constructor(){super(401,"Credentials required")}}class _e extends we{constructor(e){super(e.toLowerCase()),this.reason=e}}class xe extends ye{constructor(e){super(401,e.toLowerCase()),this.reason=e,this.reason=e}}const Ie=/^Bearer$/i;function Pe(e){if("string"==typeof e||e instanceof Buffer)return function(e){return{type:"promise",content:(t,r)=>new Promise(t=>{t(e.content)})}}({type:"basic",content:e});if(e instanceof Promise||"AsyncFunction"===e.constructor.name||"GeneratorFunction"===e.constructor.name)return{type:"promise",content:e};if("function"==typeof e&&4===e.length)return t={type:"callback",content:e},{type:"promise",content:(e,r,n)=>new Promise((o,i)=>t.content(e,r,n,(e,t)=>e?i(e):t?o(t):i(new Error("secret couldn't be retrieved"))))};throw new Error("jwt: secret field can be of type: string | Buffer | Promise | Function(req, jwtheader, payload, cb(err, ?secret))");var t}const Ne=e=>{if(!e||0===Object.keys(e).length)throw new Error("options can't be missing or empty, has required fields: [secret, algorithms]");if(!e.algorithms)throw new Error("jwt: algorithms field can't be undefined, must be an array of type string: [string]");if(!Array.isArray(e.algorithms))throw new Error("jwt: algorithms field must be an array of type string: [string]");const t=e.userProperty||e.requestProperty||"user",r=e.resultProperty,n=null==e.credentialsRequired||e.credentialsRequired,o=Pe(e.secret);let i=null!=e.get_token;return async(a,s,c)=>{try{let u="";if("OPTIONS"===a.method&&a.headers.hasOwnProperty("access-control-request-headers")&&(e=>(e.headers["access-control-request-headers"]||"").split(",").map(e=>e.trim()).includes("authorization"))(a))return c();if(i)u=e.get_token(a);else if(a.headers&&a.headers.authorization){const e=a.headers&&a.headers.authorization.split(" ");if(2!==e.length)throw new Se;{const t=e[0],r=e[1];if(!Ie.test(t)){if(n)throw new Ee;return c()}u=r}}if(!u){if(n)throw new ke;return c()}let l=d({complete:!0})(u,{checkTyp:e.token_type});const p=function(e){let{key:t,algorithms:r,complete:n,cache:o,cacheTTL:i,checkTyp:a,clockTimestamp:s,clockTolerance:c,ignoreExpiration:u,ignoreNotBefore:l,maxAge:f,allowedJti:p,allowedAud:y,allowedIss:m,allowedSub:w,allowedNonce:g}={cacheTTL:6e5,...e};Array.isArray(r)||(r=[]);const b=typeof t;if("string"!==b&&"object"!==b&&"function"!==b)throw new h(h.codes.INVALID_OPTION,"The key option must be a string, a buffer or a function returning the algorithm secret or public key.");if(t&&"function"!==b){const e=ee(t);r.length?ie(r,e):r=e,t=ae(t,e[0]===Y[0])}if(s&&("number"!=typeof s||s<0))throw new h(h.codes.invalidOption,"The clockTimestamp option must be a positive number.");if(c&&("number"!=typeof c||c<0))throw new h(h.codes.invalidOption,"The clockTolerance option must be a positive number.");if(c=0,i&&("number"!=typeof i||i<0))throw new h(h.codes.invalidOption,"The cacheTTL option must be a positive number.");const v=[];l||v.push({type:"date",claim:"nbf",errorCode:"inactive",errorVerb:"will be active",greater:!0}),u||v.push({type:"date",claim:"exp",errorCode:"expired",errorVerb:"has expired"}),"number"==typeof f&&v.push({type:"date",claim:"iat",errorCode:"expired",errorVerb:"has expired",modifier:f}),p&&v.push({type:"string",claim:"jti",allowed:se(p)}),y&&v.push({type:"string",claim:"aud",allowed:se(y),array:!0}),m&&v.push({type:"string",claim:"iss",allowed:se(m)}),w&&v.push({type:"string",claim:"sub",allowed:se(w)}),g&&v.push({type:"string",claim:"nonce",allowed:se(g)});let A=null;a&&(A=a.toLowerCase().replace(/^application\//,""));const T={key:t,allowedAlgorithms:r,complete:n,cacheTTL:i,checkTyp:A,clockTimestamp:s,clockTolerance:c,ignoreExpiration:u,ignoreNotBefore:l,maxAge:f,isAsync:"function"===b,validators:v,decode:d({complete:!0}),cache:ce(o)},E=de.bind(null,T);return E.cache=T.cache,E}({key:async()=>await o.content(a,l.header,l.payload),complete:!0,allowedAud:e.audience,allowedIss:e.issuer}),y=await p(u);if(await((t,r)=>new Promise((n,o)=>{if(!e.is_revoked)return n(!1);e.is_revoked(t,r,(e,t)=>{if(e)return o(e);n(t)})}))(a,l.payload))throw new me("internal ruleset");r?f(s,r,y.payload):f(a,t,y.payload),c()}catch(t){switch(t.code){case h.codes.invalidType:return c(new ge(e?.token_type,t.header));case h.codes.malformed:return c(new be);case h.codes.invalidPayload:return c(new ve);case h.codes.invalidSignature:return c(new Ae);case h.codes.invalidClaimValue:return c(new Te(t.message));case h.codes.expired:return c(new _e(t.message));case h.codes.keyFetchingError:return c(new xe(t.message));default:return c(t)}}}};export{Ne as JWT};
