Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crypto"),t=require("buffer"),r=require("just-safe-set");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(t),i=n(r);class a extends Error{constructor(e,t,r){if(super(t),Error.captureStackTrace(this,this.constructor),this.code=e,r)for(const e in r)this[e]=r[e]}}function s({complete:e,checkTyp:t},r){if(r instanceof Buffer)r=r.toString("utf-8");else if("string"!=typeof r)throw new a(a.codes.invalidType,"The token must be a string or a buffer.");const n=r.indexOf("."),o=r.lastIndexOf(".");if(-1===n||n>=o)throw new a(a.codes.malformed,"The token is malformed.");let i=!1;try{const s=JSON.parse(Buffer.from(r.slice(0,n),"base64").toString("utf-8"));if(t&&s.typ!==t)throw new a(a.codes.invalidType,`The type must be "${t}".`,{header:s});i=!0;let c=Buffer.from(r.slice(n+1,o),"base64").toString("utf-8");if(c=JSON.parse(c),!c||"object"!=typeof c)throw new a(a.codes.invalidPayload,"The payload must be an object",{payload:c});return e?{header:s,payload:c,signature:r.slice(o+1),input:r.slice(0,o)}:c}catch(e){throw a.wrap(e,a.codes.malformed,`The token ${i?"payload":"header"} is not a valid base64url serialized JSON.`)}}function c(e={}){const t=e.complete||!1,r=e.checkTyp;return s.bind(null,{complete:t,checkTyp:r})}a.codes={invalidType:"FAST_JWT_INVALID_TYPE",invalidOption:"FAST_JWT_INVALID_OPTION",invalidAlgorithm:"FAST_JWT_INVALID_ALGORITHM",invalidClaimType:"FAST_JWT_INVALID_CLAIM_TYPE",invalidClaimValue:"FAST_JWT_INVALID_CLAIM_VALUE",invalidKey:"FAST_JWT_INVALID_KEY",invalidSignature:"FAST_JWT_INVALID_SIGNATURE",invalidPayload:"FAST_JWT_INVALID_PAYLOAD",malformed:"FAST_JWT_MALFORMED",inactive:"FAST_JWT_INACTIVE",expired:"FAST_JWT_EXPIRED",missingKey:"FAST_JWT_MISSING_KEY",keyFetchingError:"FAST_JWT_KEY_FETCHING_ERROR",signError:"FAST_JWT_SIGN_ERROR",verifyError:"FAST_JWT_VERIFY_ERROR"},a.wrap=function(e,t,r){return e instanceof a?e:new a(t,r,{originalError:e})};var u,l,f=(function(e,t){
/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
var r=o.default.Buffer;function n(e,t){for(var r in e)t[r]=e[r]}function i(e,t,n){return r(e,t,n)}r.from&&r.alloc&&r.allocUnsafe&&r.allocUnsafeSlow?e.exports=o.default:(n(o.default,t),t.Buffer=i),i.prototype=Object.create(r.prototype),n(r,i),i.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return r(e,t,n)},i.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var o=r(e);return void 0!==t?"string"==typeof n?o.fill(t,n):o.fill(t):o.fill(0),o},i.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r(e)},i.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return o.default.SlowBuffer(e)}}(l={path:u,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&l.path)}},l.exports),l.exports);function h(e){return(e/8|0)+(e%8==0?0:1)}var p={ES256:h(256),ES384:h(384),ES512:h(521)};var d=function(e){var t=p[e];if(t)return t;throw new Error('Unknown algorithm "'+e+'"')},y=f.Buffer;function m(e){if(y.isBuffer(e))return e;if("string"==typeof e)return y.from(e,"base64");throw new TypeError("ECDSA signature must be a Base64 string or a Buffer")}function w(e,t,r){for(var n=0;t+n<r&&0===e[t+n];)++n;return e[t+n]>=128&&--n,n}var g={derToJose:function(e,t){e=m(e);var r=d(t),n=r+1,o=e.length,i=0;if(48!==e[i++])throw new Error('Could not find expected "seq"');var a=e[i++];if(129===a&&(a=e[i++]),o-i<a)throw new Error('"seq" specified length of "'+a+'", only "'+(o-i)+'" remaining');if(2!==e[i++])throw new Error('Could not find expected "int" for "r"');var s=e[i++];if(o-i-2<s)throw new Error('"r" specified length of "'+s+'", only "'+(o-i-2)+'" available');if(n<s)throw new Error('"r" specified length of "'+s+'", max of "'+n+'" is acceptable');var c=i;if(i+=s,2!==e[i++])throw new Error('Could not find expected "int" for "s"');var u=e[i++];if(o-i!==u)throw new Error('"s" specified length of "'+u+'", expected "'+(o-i)+'"');if(n<u)throw new Error('"s" specified length of "'+u+'", max of "'+n+'" is acceptable');var l=i;if((i+=u)!==o)throw new Error('Expected to consume entire buffer, but "'+(o-i)+'" bytes remain');var f=r-s,h=r-u,p=y.allocUnsafe(f+s+h+u);for(i=0;i<f;++i)p[i]=0;e.copy(p,i,c+Math.max(-f,0),c+s);for(var w=i=r;i<w+h;++i)p[i]=0;return e.copy(p,i,l+Math.max(-h,0),l+u),p=(p=p.toString("base64")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},joseToDer:function(e,t){e=m(e);var r=d(t),n=e.length;if(n!==2*r)throw new TypeError('"'+t+'" signatures must be "'+2*r+'" bytes, saw "'+n+'"');var o=w(e,0,r),i=w(e,r,e.length),a=r-o,s=r-i,c=2+a+1+1+s,u=c<128,l=y.allocUnsafe((u?2:3)+c),f=0;return l[f++]=48,u?l[f++]=c:(l[f++]=129,l[f++]=255&c),l[f++]=2,l[f++]=a,o<0?(l[f++]=0,f+=e.copy(l,f,0,r)):f+=e.copy(l,f,o,r),l[f++]=2,l[f++]=s,i<0?(l[f++]=0,e.copy(l,f,r)):e.copy(l,f,r+i),l}};function b(e){Object.defineProperty(this,"_next",{writable:!1,enumerable:!1,value:e}),this.done=!1}b.prototype.next=function(){if(this.done)return{done:!0};var e=this._next();return e.done&&(this.done=!0),e},"undefined"!=typeof Symbol&&(b.prototype[Symbol.iterator]=function(){return this}),b.of=function(){var e=arguments,t=e.length,r=0;return new b((function(){return r>=t?{done:!0}:{done:!1,value:e[r++]}}))},b.empty=function(){var e=new b(null);return e.done=!0,e},b.is=function(e){return e instanceof b||"object"==typeof e&&null!==e&&"function"==typeof e.next};var v=b,A="undefined"!=typeof ArrayBuffer,T="undefined"!=typeof Symbol;function S(e,t){var r,n,o,i,a;if(!e)throw new Error("obliterator/forEach: invalid iterable.");if("function"!=typeof t)throw new Error("obliterator/forEach: expecting a callback.");if(Array.isArray(e)||A&&ArrayBuffer.isView(e)||"string"==typeof e||"[object Arguments]"===e.toString())for(o=0,i=e.length;o<i;o++)t(e[o],o);else if("function"!=typeof e.forEach)if(T&&Symbol.iterator in e&&"function"!=typeof e.next&&(e=e[Symbol.iterator]()),"function"!=typeof e.next)for(n in e)e.hasOwnProperty(n)&&t(e[n],n);else for(r=e,o=0;!0!==(a=r.next()).done;)t(a.value,o),o++;else e.forEach(t)}S.forEachWithNullKeys=function(e,t){var r,n,o,i,a;if(!e)throw new Error("obliterator/forEachWithNullKeys: invalid iterable.");if("function"!=typeof t)throw new Error("obliterator/forEachWithNullKeys: expecting a callback.");if(Array.isArray(e)||A&&ArrayBuffer.isView(e)||"string"==typeof e||"[object Arguments]"===e.toString())for(o=0,i=e.length;o<i;o++)t(e[o],null);else if(e instanceof Set)e.forEach((function(e){t(e,null)}));else if("function"!=typeof e.forEach)if(T&&Symbol.iterator in e&&"function"!=typeof e.next&&(e=e[Symbol.iterator]()),"function"!=typeof e.next)for(n in e)e.hasOwnProperty(n)&&t(e[n],n);else for(r=e,o=0;!0!==(a=r.next()).done;)t(a.value,null),o++;else e.forEach(t)};var E,k=S,_=(function(e,t){var r=Math.pow(2,8)-1,n=Math.pow(2,16)-1,o=Math.pow(2,32)-1,i=Math.pow(2,7)-1,a=Math.pow(2,15)-1,s=Math.pow(2,31)-1;t.getPointerArray=function(e){var t=e-1;return t<=r?Uint8Array:t<=n?Uint16Array:t<=o?Uint32Array:Float64Array},t.getSignedPointerArray=function(e){var t=e-1;return t<=i?Int8Array:t<=a?Int16Array:t<=s?Int32Array:Float64Array},t.getNumberType=function(e){return e===(0|e)?-1===Math.sign(e)?e<=127&&e>=-128?Int8Array:e<=32767&&e>=-32768?Int16Array:Int32Array:e<=255?Uint8Array:e<=65535?Uint16Array:Uint32Array:Float64Array};var c={Uint8Array:1,Int8Array:2,Uint16Array:3,Int16Array:4,Uint32Array:5,Int32Array:6,Float32Array:7,Float64Array:8};t.getMinimalRepresentation=function(e,r){var n,o,i,a,s,u=null,l=0;for(a=0,s=e.length;a<s;a++)i=r?r(e[a]):e[a],o=t.getNumberType(i),(n=c[o.name])>l&&(l=n,u=o);return u},t.isTypedArray=function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView(e)},t.concat=function(){var e,t,r,n=0;for(e=0,r=arguments.length;e<r;e++)n+=arguments[e].length;var o=new arguments[0].constructor(n);for(e=0,t=0;e<r;e++)o.set(arguments[e],t),t+=arguments[e].length;return o},t.indices=function(e){for(var r=new(t.getPointerArray(e))(e),n=0;n<e;n++)r[n]=n;return r}}(E={path:undefined,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&E.path)}},E.exports),E.exports),x=_.isTypedArray;function I(e){return"number"==typeof e.length?e.length:"number"==typeof e.size?e.size:void 0}var P={isArrayLike:function(e){return Array.isArray(e)||x(e)},guessLength:I,toArray:function(e){var t=I(e),r="number"==typeof t?new Array(t):[],n=0;return k(e,(function(e){r[n++]=e})),r}};function N(e,t,r){if(arguments.length<2&&(r=e,e=null,t=null),this.capacity=r,"number"!=typeof this.capacity||this.capacity<=0)throw new Error("mnemonist/lru-cache: capacity should be positive number.");var n=_.getPointerArray(r);this.forward=new n(r),this.backward=new n(r),this.K="function"==typeof e?new e(r):new Array(r),this.V="function"==typeof t?new t(r):new Array(r),this.size=0,this.head=0,this.tail=0,this.items={}}N.prototype.clear=function(){this.size=0,this.head=0,this.tail=0,this.items={}},N.prototype.splayOnTop=function(e){var t=this.head;if(this.head===e)return this;var r=this.backward[e],n=this.forward[e];return this.tail===e?this.tail=r:this.backward[n]=r,this.forward[r]=n,this.backward[t]=e,this.head=e,this.forward[e]=t,this},N.prototype.set=function(e,t){var r=this.items[e];if(void 0!==r)return this.splayOnTop(r),void(this.V[r]=t);this.size<this.capacity?r=this.size++:(r=this.tail,this.tail=this.backward[r],delete this.items[this.K[r]]),this.items[e]=r,this.K[r]=e,this.V[r]=t,this.forward[r]=this.head,this.backward[this.head]=r,this.head=r},N.prototype.setpop=function(e,t){var r=null,n=null,o=this.items[e];return void 0!==o?(this.splayOnTop(o),r=this.V[o],this.V[o]=t,{evicted:!1,key:e,value:r}):(this.size<this.capacity?o=this.size++:(o=this.tail,this.tail=this.backward[o],r=this.V[o],n=this.K[o],delete this.items[this.K[o]]),this.items[e]=o,this.K[o]=e,this.V[o]=t,this.forward[o]=this.head,this.backward[this.head]=o,this.head=o,n?{evicted:!0,key:n,value:r}:null)},N.prototype.has=function(e){return e in this.items},N.prototype.get=function(e){var t=this.items[e];if(void 0!==t)return this.splayOnTop(t),this.V[t]},N.prototype.peek=function(e){var t=this.items[e];if(void 0!==t)return this.V[t]},N.prototype.forEach=function(e,t){t=arguments.length>1?t:this;for(var r=0,n=this.size,o=this.head,i=this.K,a=this.V,s=this.forward;r<n;)e.call(t,a[o],i[o],this),o=s[o],r++},N.prototype.keys=function(){var e=0,t=this.size,r=this.head,n=this.K,o=this.forward;return new v((function(){if(e>=t)return{done:!0};var i=n[r];return++e<t&&(r=o[r]),{done:!1,value:i}}))},N.prototype.values=function(){var e=0,t=this.size,r=this.head,n=this.V,o=this.forward;return new v((function(){if(e>=t)return{done:!0};var i=n[r];return++e<t&&(r=o[r]),{done:!1,value:i}}))},N.prototype.entries=function(){var e=0,t=this.size,r=this.head,n=this.K,o=this.V,i=this.forward;return new v((function(){if(e>=t)return{done:!0};var a=n[r],s=o[r];return++e<t&&(r=i[r]),{done:!1,value:[a,s]}}))},"undefined"!=typeof Symbol&&(N.prototype[Symbol.iterator]=N.prototype.entries),N.prototype.inspect=function(){for(var e,t=new Map,r=this.entries();!(e=r.next()).done;)t.set(e.value[0],e.value[1]);return Object.defineProperty(t,"constructor",{value:N,enumerable:!1}),t},"undefined"!=typeof Symbol&&(N.prototype[Symbol.for("nodejs.util.inspect.custom")]=N.prototype.inspect),N.from=function(e,t,r,n){if(arguments.length<2){if("number"!=typeof(n=P.guessLength(e)))throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else 2===arguments.length&&(n=t,t=null,r=null);var o=new N(t,r,n);return k(e,(function(e,t){o.set(t,e)})),o};var j=N;const L=require("asn1.js").define,{RSA_PKCS1_PSS_PADDING:C,RSA_PSS_SALTLEN_DIGEST:K,RSA_PKCS1_PADDING:O,RSA_PSS_SALTLEN_MAX_SIGN:V,RSA_PSS_SALTLEN_AUTO:B}=e.constants;let R=e.sign;const D=e.verify,F="function"==typeof R,q=/^-----BEGIN(?: (RSA|EC))? PRIVATE KEY-----/,U=(new j(1e3),new j(1e3)),M=["HS256","HS384","HS512"],J=["RS256","RS384","RS512","PS256","PS384","PS512"],W={"1.2.840.10045.3.1.7":{bits:"256",names:["P-256","prime256v1"]},"1.3.132.0.10":{bits:"256",names:["secp256k1"]},"1.3.132.0.34":{bits:"384",names:["P-384","secp384r1"]},"1.3.132.0.35":{bits:"512",names:["P-521","secp521r1"]}};F||(R=function(t,r,n){if(void 0===t)throw new a(a.codes.signError,"EdDSA algorithms are not supported by your Node.js version.");return e.createSign(t).update(r).sign(n)});L("PrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("algorithm").seq().obj(this.key("algorithm").objid(),this.key("parameters").optional().objid()))}));const z=L("PublicKey",(function(){this.seq().obj(this.key("algorithm").seq().obj(this.key("algorithm").objid(),this.key("parameters").optional().objid()))}));L("ECPrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("privateKey").octstr(),this.key("parameters").explicit(0).optional().choice({namedCurve:this.objid()}))}));function $(e,t,r,n){return e.set(t,[r,n]),r||n}function G(e){if(!e)return"none";const[t,r]=U.get(e)||[];if(t)return t;if(r)throw r;try{if(e instanceof Buffer)e=e.toString("utf-8");else if("string"!=typeof e)throw new a(a.codes.invalidKey,"The public key must be a string or a buffer.");return $(U,e,function(e){if(e.match(q))throw new a(a.codes.invalidKey,"Private keys are not supported for verifying.");if(!e.includes("-----BEGIN PUBLIC KEY-----"))return M;const t=z.decode(e,"pem",{label:"PUBLIC KEY"}),r=t.algorithm.algorithm.join(".");let n;switch(r){case"1.2.840.113549.1.1.1":return J;case"1.2.840.10045.2.1":n=t.algorithm.parameters.join(".");break;case"1.3.101.112":case"1.3.101.113":return["EdDSA"];default:throw new a(a.codes.invalidKey,`Unsupported PEM PCKS8 public key with OID ${r}.`)}const o=W[n];if(!o)throw new a(a.codes.invalidKey,`Unsupported EC public key with curve ${n}.`);return["ES"+o.bits]}(e))}catch(t){throw $(U,e,null,a.wrap(t,a.codes.invalidKey,"Unsupported PEM public key."))}}const H=/"alg"\s*:\s*"[HERP]S(256|384)"/m,Y=/"alg"\s*:\s*"EdDSA"/m,X=/"crv"\s*:\s*"Ed448"/m;function Q(t){const r=t.split(".",1)[0],n=Buffer.from(r,"base64").toString("utf-8");let o=null;if(n.match(Y)&&n.match(X))o=e.createHash("shake256",{outputLength:114});else{const t=n.match(H);o=e.createHash("sha"+(t?t[1]:"512"))}return o.update(t).digest("hex")}function Z(e,t){const r=e[0].slice(0,2),n=t[0].slice(0,2);let o=!0;if("RS"===r||"PS"===r?o="RS"===n:"ES"!==r&&"Ed"!==r||(o=r===n),!o)throw new a(a.codes.invalidKey,`Invalid public key provided for algorithms ${e.join(", ")}.`)}function ee(t,r){return"string"==typeof t&&(t=Buffer.from(t,"utf-8")),F&&(t=r?e.createSecretKey(t):e.createPublicKey(t)),t}function te(e){return Array.isArray(e)||(e=[e]),e.map(e=>e&&"function"==typeof e.test?e:new RegExp(e.toString()))}function re(e){const t=parseInt(!0===e?1e3:e,10);return t>0?new j(t):null}function ne({cache:e,token:t,cacheTTL:r,payload:n,ignoreExpiration:o,ignoreNotBefore:i,maxAge:a,clockTimestamp:s,clockTolerance:c},u){if(!e)return u;const l=[u,0,0];n&&"number"==typeof n.iat&&(l[1]=i||"number"!=typeof n.nbf?0:1e3*n.nbf,o||("number"==typeof n.exp?l[2]=1e3*n.exp:a&&(l[2]=1e3*n.iat+a)));const f=(s||Date.now())+c+r;return l[2]=0===l[2]?f:Math.min(l[2],f),e.set(Q(t),l),u}function oe(e,t,r,n){const o=r?`The ${t} claim must be a ${n} or an array of ${n}s.`:`The ${t} claim must be a ${n}.`;if(e.map(e=>typeof e).some(e=>e!==n))throw new a(a.codes.invalidClaimType,o)}function ie(e,t,r,n){const o=n?`None of ${t} claim values is allowed.`:`The ${t} claim value is not allowed.`;if(!e.some(e=>r.some(t=>t.test(e))))throw new a(a.codes.invalidClaimValue,o)}function ae(e,t,r,n,o,i){const s=1e3*e+(t||0);if(!(n?r>=s:r<=s))throw new a(a.codes[o],`The token ${i} at ${new Date(s).toISOString()}.`)}function se(t,{input:r,header:n,payload:o,signature:i},{validators:s,allowedAlgorithms:c,checkTyp:u,clockTimestamp:l,clockTolerance:f}){const h=t instanceof Buffer?t.length:!!t;if(h&&!i)throw new a(a.codes.missingSignature,"The token signature is missing.");if(!h&&i)throw new a(a.codes.missingKey,"The key option is missing.");if(function(t,r,n,o,i){if(!i.includes(r.alg))throw new a(a.codes.invalidAlgorithm,"The token algorithm is invalid.");if(n&&!function(t,r,n,o){try{const i=t.slice(0,2),s="SHA"+t.slice(2);if(o=Buffer.from(o,"base64"),"HS"===i)try{return e.timingSafeEqual(e.createHmac(s,r).update(n).digest(),o)}catch(e){return!1}else if("Ed"===i){if("function"==typeof D)return D(void 0,Buffer.from(n,"utf-8"),r,o);throw new a(a.codes.signError,"EdDSA algorithms are not supported by your Node.js version.")}const c={key:r,padding:O,saltLength:B};return"PS"===i?(c.padding=C,c.saltLength=K):"ES"===i&&(o=g.joseToDer(o,t)),e.createVerify("RSA-"+s).update(n).verify(c,o)}catch(t){throw new a(a.codes.verifyError,"Cannot verify the signature.",{originalError:t})}}(r.alg,o,t,n))throw new a(a.codes.invalidSignature,"The token signature is invalid.")}(r,n,i,t,c),u&&("string"!=typeof n.typ||u!==n.typ.toLowerCase().replace(/^application\//,"")))throw new a(a.codes.invalidType,"Invalid typ.");const p=(l||Date.now())+f;for(const e of s){const{type:t,claim:r,allowed:n,array:i,modifier:a,greater:s,errorCode:c,errorVerb:u}=e,l=o[r],f=Array.isArray(l),h=f?l:[l];r in o&&(oe(h,r,i,"date"===t?"number":"string"),"date"===t?ae(l,a,p,s,c,u):ie(h,r,n,f))}}function ce({key:e,allowedAlgorithms:t,complete:r,cacheTTL:n,checkTyp:o,clockTimestamp:i,clockTolerance:s,ignoreExpiration:c,ignoreNotBefore:u,maxAge:l,isAsync:f,validators:h,decode:p,cache:d},y,m){const[w,g]=f?function(e){if("function"==typeof e)return[e];let t,r;return[function(e,n){return e?r(e):t(n)},new Promise((e,n)=>{t=e,r=n})]}(m):[],b={cache:d,token:y,cacheTTL:n,payload:void 0,ignoreExpiration:c,ignoreNotBefore:u,maxAge:l,clockTimestamp:i,clockTolerance:s};if(d){const[e,t,r]=d.get(Q(y))||[void 0,0,0],n=(i||Date.now())+s;if(void 0!==e&&(0===t||n>t)&&(0===r||n<=r))return function(e,t,r){if(e instanceof a){if(!t)throw e;t(e)}else{if(!t)return e;t(null,e)}return r}(e,w,g)}let v;try{v=p(y)}catch(e){if(w)return w(e),g;throw e}const{header:A,payload:T,signature:S}=v;b.payload=T;const E={validators:h,allowedAlgorithms:t,checkTyp:o,clockTimestamp:i,clockTolerance:s};if(!w)try{return se(e,v,E),ne(b,r?{header:A,payload:T,signature:S}:T)}catch(e){throw ne(b,e)}return function(e,t,r){const n=e(t,r);n&&"function"==typeof n.then&&n.then(e=>{process.nextTick(()=>r(null,e))}).catch(r)}(e,A,(e,n)=>{if(e)return w(ne(b,a.wrap(e,a.codes.keyFetchingError,"Cannot fetch key.")));if("string"==typeof n)n=Buffer.from(n,"utf-8");else if(!(n instanceof Buffer))return w(ne(b,new a(a.codes.keyFetchingError,"The key returned from the callback must be a string or a buffer containing a secret or a public key.")));try{const e=G(n);E.allowedAlgorithms.length?Z(t,e):E.allowedAlgorithms=e,se(n=ee(n,e[0]===M[0]),v,E)}catch(e){return w(ne(b,e))}w(null,ne(b,r?{header:A,payload:T,signature:S}:T))}),g}Array.from(new Set([...M,"ES256","ES384","ES512",...J,"EdDSA","none"])).join(", ");class ue extends Error{constructor(e,t){super(t),this.code=e,this.name=this.constructor.name,this.code=e}}class le extends ue{constructor(e){super(401,"Revoked token, reason: "+e),this.reason=e,this.reason=e}}class fe extends ue{constructor(e){super(401,"Invalid token, reason: "+e),this.reason=e,this.reason=e}}class he extends fe{constructor(e,t){super(void 0!==e?"token must be of type '"+e+(void 0!==t?.typ?`' but is of type '${t.typ}.`:"."):"token must be a string or a buffer."),this.typ=e}}class pe extends fe{constructor(){super("token is malformed.")}}class de extends fe{constructor(){super("token payload must be an object.")}}class ye extends fe{constructor(){super("token signature is invalid.")}}class me extends fe{constructor(e){super(e.toLowerCase()),this.reason=e}}class we extends ue{constructor(){super(401,"Credentials bad scheme")}}class ge extends ue{constructor(){super(401,"Credentials bad format")}}class be extends ue{constructor(){super(401,"Credentials required")}}class ve extends fe{constructor(e){super(e.toLowerCase()),this.reason=e}}class Ae extends ue{constructor(e){super(401,e.toLowerCase()),this.reason=e,this.reason=e}}const Te=/^Bearer$/i;function Se(e){if("string"==typeof e||e instanceof Buffer)return function(e){return{type:"promise",content:(t,r)=>new Promise(t=>{t(e.content)})}}({type:"basic",content:e});if(e instanceof Promise||"AsyncFunction"===e.constructor.name||"GeneratorFunction"===e.constructor.name)return{type:"promise",content:e};if("function"==typeof e&&4===e.length)return t={type:"callback",content:e},{type:"promise",content:(e,r,n)=>new Promise((o,i)=>t.content(e,r,n,(e,t)=>e?i(e):t?o(t):i(new Error("secret couldn't be retrieved"))))};throw new Error("jwt: secret field can be of type: string | Buffer | Promise | Function(req, jwtheader, payload, cb(err, ?secret))");var t}exports.JWT=e=>{if(!e||0===Object.keys(e).length)throw new Error("options can't be missing or empty, has required fields: [secret, algorithms]");if(!e.algorithms)throw new Error("jwt: algorithms field can't be undefined, must be an array of type string: [string]");if(!Array.isArray(e.algorithms))throw new Error("jwt: algorithms field must be an array of type string: [string]");const t=e.userProperty||e.requestProperty||"user",r=e.resultProperty,n=null==e.credentialsRequired||e.credentialsRequired,o=Se(e.secret);let s=null!=e.get_token;return async(u,l,f)=>{try{let h="";if("OPTIONS"===u.method&&u.headers.hasOwnProperty("access-control-request-headers")&&(e=>(e.headers["access-control-request-headers"]||"").split(",").map(e=>e.trim()).includes("authorization"))(u))return f();if(s)h=e.get_token(u);else if(u.headers&&u.headers.authorization){const e=u.headers&&u.headers.authorization.split(" ");if(2!==e.length)throw new ge;{const t=e[0],r=e[1];if(!Te.test(t)){if(n)throw new we;return f()}h=r}}if(!h){if(n)throw new be;return f()}let p=c({complete:!0})(h,{checkTyp:e.token_type});const d=function(e){let{key:t,algorithms:r,complete:n,cache:o,cacheTTL:i,checkTyp:s,clockTimestamp:u,clockTolerance:l,ignoreExpiration:f,ignoreNotBefore:h,maxAge:p,allowedJti:d,allowedAud:y,allowedIss:m,allowedSub:w,allowedNonce:g}={cacheTTL:6e5,...e};Array.isArray(r)||(r=[]);const b=typeof t;if("string"!==b&&"object"!==b&&"function"!==b)throw new a(a.codes.INVALID_OPTION,"The key option must be a string, a buffer or a function returning the algorithm secret or public key.");if(t&&"function"!==b){const e=G(t);r.length?Z(r,e):r=e,t=ee(t,e[0]===M[0])}if(u&&("number"!=typeof u||u<0))throw new a(a.codes.invalidOption,"The clockTimestamp option must be a positive number.");if(l&&("number"!=typeof l||l<0))throw new a(a.codes.invalidOption,"The clockTolerance option must be a positive number.");if(l=0,i&&("number"!=typeof i||i<0))throw new a(a.codes.invalidOption,"The cacheTTL option must be a positive number.");const v=[];h||v.push({type:"date",claim:"nbf",errorCode:"inactive",errorVerb:"will be active",greater:!0}),f||v.push({type:"date",claim:"exp",errorCode:"expired",errorVerb:"has expired"}),"number"==typeof p&&v.push({type:"date",claim:"iat",errorCode:"expired",errorVerb:"has expired",modifier:p}),d&&v.push({type:"string",claim:"jti",allowed:te(d)}),y&&v.push({type:"string",claim:"aud",allowed:te(y),array:!0}),m&&v.push({type:"string",claim:"iss",allowed:te(m)}),w&&v.push({type:"string",claim:"sub",allowed:te(w)}),g&&v.push({type:"string",claim:"nonce",allowed:te(g)});let A=null;s&&(A=s.toLowerCase().replace(/^application\//,""));const T={key:t,allowedAlgorithms:r,complete:n,cacheTTL:i,checkTyp:A,clockTimestamp:u,clockTolerance:l,ignoreExpiration:f,ignoreNotBefore:h,maxAge:p,isAsync:"function"===b,validators:v,decode:c({complete:!0}),cache:re(o)},S=ce.bind(null,T);return S.cache=T.cache,S}({key:async()=>await o.content(u,p.header,p.payload),complete:!0,allowedAud:e.audience,allowedIss:e.issuer}),y=await d(h);if(await((t,r)=>new Promise((n,o)=>{if(!e.is_revoked)return n(!1);e.is_revoked(t,r,(e,t)=>{if(e)return o(e);n(t)})}))(u,p.payload))throw new le("internal ruleset");r?i.default(l,r,y.payload):i.default(u,t,y.payload),f()}catch(t){switch(t.code){case a.codes.invalidType:return f(new he(e?.token_type,t.header));case a.codes.malformed:return f(new pe);case a.codes.invalidPayload:return f(new de);case a.codes.invalidSignature:return f(new ye);case a.codes.invalidClaimValue:return f(new me(t.message));case a.codes.expired:return f(new ve(t.message));case a.codes.keyFetchingError:return f(new Ae(t.message));default:return f(t)}}}};
