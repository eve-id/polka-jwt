Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crypto");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=t(require("buffer"));class n extends Error{constructor(e,t,r){if(super(t),Error.captureStackTrace(this,this.constructor),this.code=e,r)for(const e in r)this[e]=r[e]}}function o({complete:e,checkTyp:t},r){if(r instanceof Buffer)r=r.toString("utf-8");else if("string"!=typeof r)throw new n(n.codes.invalidType,"The token must be a string or a buffer.");const o=r.indexOf("."),i=r.lastIndexOf(".");if(-1===o||o>=i)throw new n(n.codes.malformed,"The token is malformed.");let a=!1;try{const s=JSON.parse(Buffer.from(r.slice(0,o),"base64").toString("utf-8"));if(t&&s.typ!==t)throw new n(n.codes.invalidType,`The type must be "${t}".`,{header:s});a=!0;let c=Buffer.from(r.slice(o+1,i),"base64").toString("utf-8");if(c=JSON.parse(c),!c||"object"!=typeof c)throw new n(n.codes.invalidPayload,"The payload must be an object",{payload:c});return e?{header:s,payload:c,signature:r.slice(i+1),input:r.slice(0,i)}:c}catch(e){throw n.wrap(e,n.codes.malformed,`The token ${a?"payload":"header"} is not a valid base64url serialized JSON.`)}}function i(e={}){const t=e.complete||!1,r=e.checkTyp;return o.bind(null,{complete:t,checkTyp:r})}n.codes={invalidType:"FAST_JWT_INVALID_TYPE",invalidOption:"FAST_JWT_INVALID_OPTION",invalidAlgorithm:"FAST_JWT_INVALID_ALGORITHM",invalidClaimType:"FAST_JWT_INVALID_CLAIM_TYPE",invalidClaimValue:"FAST_JWT_INVALID_CLAIM_VALUE",invalidKey:"FAST_JWT_INVALID_KEY",invalidSignature:"FAST_JWT_INVALID_SIGNATURE",invalidPayload:"FAST_JWT_INVALID_PAYLOAD",malformed:"FAST_JWT_MALFORMED",inactive:"FAST_JWT_INACTIVE",expired:"FAST_JWT_EXPIRED",missingKey:"FAST_JWT_MISSING_KEY",keyFetchingError:"FAST_JWT_KEY_FETCHING_ERROR",signError:"FAST_JWT_SIGN_ERROR",verifyError:"FAST_JWT_VERIFY_ERROR"},n.wrap=function(e,t,r){return e instanceof n?e:new n(t,r,{originalError:e})};var a,s,c=(function(e,t){
/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
var n=r.default.Buffer;function o(e,t){for(var r in e)t[r]=e[r]}function i(e,t,r){return n(e,t,r)}n.from&&n.alloc&&n.allocUnsafe&&n.allocUnsafeSlow?e.exports=r.default:(o(r.default,t),t.Buffer=i),i.prototype=Object.create(n.prototype),o(n,i),i.from=function(e,t,r){if("number"==typeof e)throw new TypeError("Argument must not be a number");return n(e,t,r)},i.alloc=function(e,t,r){if("number"!=typeof e)throw new TypeError("Argument must be a number");var o=n(e);return void 0!==t?"string"==typeof r?o.fill(t,r):o.fill(t):o.fill(0),o},i.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n(e)},i.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r.default.SlowBuffer(e)}}(s={path:a,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&s.path)}},s.exports),s.exports);function u(e){return(e/8|0)+(e%8==0?0:1)}var l={ES256:u(256),ES384:u(384),ES512:u(521)};var f=function(e){var t=l[e];if(t)return t;throw new Error('Unknown algorithm "'+e+'"')},h=c.Buffer;function p(e){if(h.isBuffer(e))return e;if("string"==typeof e)return h.from(e,"base64");throw new TypeError("ECDSA signature must be a Base64 string or a Buffer")}function d(e,t,r){for(var n=0;t+n<r&&0===e[t+n];)++n;return e[t+n]>=128&&--n,n}var y={derToJose:function(e,t){e=p(e);var r=f(t),n=r+1,o=e.length,i=0;if(48!==e[i++])throw new Error('Could not find expected "seq"');var a=e[i++];if(129===a&&(a=e[i++]),o-i<a)throw new Error('"seq" specified length of "'+a+'", only "'+(o-i)+'" remaining');if(2!==e[i++])throw new Error('Could not find expected "int" for "r"');var s=e[i++];if(o-i-2<s)throw new Error('"r" specified length of "'+s+'", only "'+(o-i-2)+'" available');if(n<s)throw new Error('"r" specified length of "'+s+'", max of "'+n+'" is acceptable');var c=i;if(i+=s,2!==e[i++])throw new Error('Could not find expected "int" for "s"');var u=e[i++];if(o-i!==u)throw new Error('"s" specified length of "'+u+'", expected "'+(o-i)+'"');if(n<u)throw new Error('"s" specified length of "'+u+'", max of "'+n+'" is acceptable');var l=i;if((i+=u)!==o)throw new Error('Expected to consume entire buffer, but "'+(o-i)+'" bytes remain');var d=r-s,y=r-u,m=h.allocUnsafe(d+s+y+u);for(i=0;i<d;++i)m[i]=0;e.copy(m,i,c+Math.max(-d,0),c+s);for(var w=i=r;i<w+y;++i)m[i]=0;return e.copy(m,i,l+Math.max(-y,0),l+u),m=(m=m.toString("base64")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},joseToDer:function(e,t){e=p(e);var r=f(t),n=e.length;if(n!==2*r)throw new TypeError('"'+t+'" signatures must be "'+2*r+'" bytes, saw "'+n+'"');var o=d(e,0,r),i=d(e,r,e.length),a=r-o,s=r-i,c=2+a+1+1+s,u=c<128,l=h.allocUnsafe((u?2:3)+c),y=0;return l[y++]=48,u?l[y++]=c:(l[y++]=129,l[y++]=255&c),l[y++]=2,l[y++]=a,o<0?(l[y++]=0,y+=e.copy(l,y,0,r)):y+=e.copy(l,y,o,r),l[y++]=2,l[y++]=s,i<0?(l[y++]=0,e.copy(l,y,r)):e.copy(l,y,r+i),l}};function m(e){Object.defineProperty(this,"_next",{writable:!1,enumerable:!1,value:e}),this.done=!1}m.prototype.next=function(){if(this.done)return{done:!0};var e=this._next();return e.done&&(this.done=!0),e},"undefined"!=typeof Symbol&&(m.prototype[Symbol.iterator]=function(){return this}),m.of=function(){var e=arguments,t=e.length,r=0;return new m((function(){return r>=t?{done:!0}:{done:!1,value:e[r++]}}))},m.empty=function(){var e=new m(null);return e.done=!0,e},m.is=function(e){return e instanceof m||"object"==typeof e&&null!==e&&"function"==typeof e.next};var w=m,g="undefined"!=typeof ArrayBuffer,b="undefined"!=typeof Symbol;function v(e,t){var r,n,o,i,a;if(!e)throw new Error("obliterator/forEach: invalid iterable.");if("function"!=typeof t)throw new Error("obliterator/forEach: expecting a callback.");if(Array.isArray(e)||g&&ArrayBuffer.isView(e)||"string"==typeof e||"[object Arguments]"===e.toString())for(o=0,i=e.length;o<i;o++)t(e[o],o);else if("function"!=typeof e.forEach)if(b&&Symbol.iterator in e&&"function"!=typeof e.next&&(e=e[Symbol.iterator]()),"function"!=typeof e.next)for(n in e)e.hasOwnProperty(n)&&t(e[n],n);else for(r=e,o=0;!0!==(a=r.next()).done;)t(a.value,o),o++;else e.forEach(t)}v.forEachWithNullKeys=function(e,t){var r,n,o,i,a;if(!e)throw new Error("obliterator/forEachWithNullKeys: invalid iterable.");if("function"!=typeof t)throw new Error("obliterator/forEachWithNullKeys: expecting a callback.");if(Array.isArray(e)||g&&ArrayBuffer.isView(e)||"string"==typeof e||"[object Arguments]"===e.toString())for(o=0,i=e.length;o<i;o++)t(e[o],null);else if(e instanceof Set)e.forEach((function(e){t(e,null)}));else if("function"!=typeof e.forEach)if(b&&Symbol.iterator in e&&"function"!=typeof e.next&&(e=e[Symbol.iterator]()),"function"!=typeof e.next)for(n in e)e.hasOwnProperty(n)&&t(e[n],n);else for(r=e,o=0;!0!==(a=r.next()).done;)t(a.value,null),o++;else e.forEach(t)};var A,T=v,S=(function(e,t){var r=Math.pow(2,8)-1,n=Math.pow(2,16)-1,o=Math.pow(2,32)-1,i=Math.pow(2,7)-1,a=Math.pow(2,15)-1,s=Math.pow(2,31)-1;t.getPointerArray=function(e){var t=e-1;return t<=r?Uint8Array:t<=n?Uint16Array:t<=o?Uint32Array:Float64Array},t.getSignedPointerArray=function(e){var t=e-1;return t<=i?Int8Array:t<=a?Int16Array:t<=s?Int32Array:Float64Array},t.getNumberType=function(e){return e===(0|e)?-1===Math.sign(e)?e<=127&&e>=-128?Int8Array:e<=32767&&e>=-32768?Int16Array:Int32Array:e<=255?Uint8Array:e<=65535?Uint16Array:Uint32Array:Float64Array};var c={Uint8Array:1,Int8Array:2,Uint16Array:3,Int16Array:4,Uint32Array:5,Int32Array:6,Float32Array:7,Float64Array:8};t.getMinimalRepresentation=function(e,r){var n,o,i,a,s,u=null,l=0;for(a=0,s=e.length;a<s;a++)i=r?r(e[a]):e[a],o=t.getNumberType(i),(n=c[o.name])>l&&(l=n,u=o);return u},t.isTypedArray=function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView(e)},t.concat=function(){var e,t,r,n=0;for(e=0,r=arguments.length;e<r;e++)n+=arguments[e].length;var o=new arguments[0].constructor(n);for(e=0,t=0;e<r;e++)o.set(arguments[e],t),t+=arguments[e].length;return o},t.indices=function(e){for(var r=new(t.getPointerArray(e))(e),n=0;n<e;n++)r[n]=n;return r}}(A={path:undefined,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&A.path)}},A.exports),A.exports),E=S.isTypedArray;function k(e){return"number"==typeof e.length?e.length:"number"==typeof e.size?e.size:void 0}var _={isArrayLike:function(e){return Array.isArray(e)||E(e)},guessLength:k,toArray:function(e){var t=k(e),r="number"==typeof t?new Array(t):[],n=0;return T(e,(function(e){r[n++]=e})),r}};function x(e,t,r){if(arguments.length<2&&(r=e,e=null,t=null),this.capacity=r,"number"!=typeof this.capacity||this.capacity<=0)throw new Error("mnemonist/lru-cache: capacity should be positive number.");var n=S.getPointerArray(r);this.forward=new n(r),this.backward=new n(r),this.K="function"==typeof e?new e(r):new Array(r),this.V="function"==typeof t?new t(r):new Array(r),this.size=0,this.head=0,this.tail=0,this.items={}}x.prototype.clear=function(){this.size=0,this.head=0,this.tail=0,this.items={}},x.prototype.splayOnTop=function(e){var t=this.head;if(this.head===e)return this;var r=this.backward[e],n=this.forward[e];return this.tail===e?this.tail=r:this.backward[n]=r,this.forward[r]=n,this.backward[t]=e,this.head=e,this.forward[e]=t,this},x.prototype.set=function(e,t){var r=this.items[e];if(void 0!==r)return this.splayOnTop(r),void(this.V[r]=t);this.size<this.capacity?r=this.size++:(r=this.tail,this.tail=this.backward[r],delete this.items[this.K[r]]),this.items[e]=r,this.K[r]=e,this.V[r]=t,this.forward[r]=this.head,this.backward[this.head]=r,this.head=r},x.prototype.setpop=function(e,t){var r=null,n=null,o=this.items[e];return void 0!==o?(this.splayOnTop(o),r=this.V[o],this.V[o]=t,{evicted:!1,key:e,value:r}):(this.size<this.capacity?o=this.size++:(o=this.tail,this.tail=this.backward[o],r=this.V[o],n=this.K[o],delete this.items[this.K[o]]),this.items[e]=o,this.K[o]=e,this.V[o]=t,this.forward[o]=this.head,this.backward[this.head]=o,this.head=o,n?{evicted:!0,key:n,value:r}:null)},x.prototype.has=function(e){return e in this.items},x.prototype.get=function(e){var t=this.items[e];if(void 0!==t)return this.splayOnTop(t),this.V[t]},x.prototype.peek=function(e){var t=this.items[e];if(void 0!==t)return this.V[t]},x.prototype.forEach=function(e,t){t=arguments.length>1?t:this;for(var r=0,n=this.size,o=this.head,i=this.K,a=this.V,s=this.forward;r<n;)e.call(t,a[o],i[o],this),o=s[o],r++},x.prototype.keys=function(){var e=0,t=this.size,r=this.head,n=this.K,o=this.forward;return new w((function(){if(e>=t)return{done:!0};var i=n[r];return++e<t&&(r=o[r]),{done:!1,value:i}}))},x.prototype.values=function(){var e=0,t=this.size,r=this.head,n=this.V,o=this.forward;return new w((function(){if(e>=t)return{done:!0};var i=n[r];return++e<t&&(r=o[r]),{done:!1,value:i}}))},x.prototype.entries=function(){var e=0,t=this.size,r=this.head,n=this.K,o=this.V,i=this.forward;return new w((function(){if(e>=t)return{done:!0};var a=n[r],s=o[r];return++e<t&&(r=i[r]),{done:!1,value:[a,s]}}))},"undefined"!=typeof Symbol&&(x.prototype[Symbol.iterator]=x.prototype.entries),x.prototype.inspect=function(){for(var e,t=new Map,r=this.entries();!(e=r.next()).done;)t.set(e.value[0],e.value[1]);return Object.defineProperty(t,"constructor",{value:x,enumerable:!1}),t},"undefined"!=typeof Symbol&&(x.prototype[Symbol.for("nodejs.util.inspect.custom")]=x.prototype.inspect),x.from=function(e,t,r,n){if(arguments.length<2){if("number"!=typeof(n=_.guessLength(e)))throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else 2===arguments.length&&(n=t,t=null,r=null);var o=new x(t,r,n);return T(e,(function(e,t){o.set(t,e)})),o};var I=x;const P=require("asn1.js").define,{RSA_PKCS1_PSS_PADDING:N,RSA_PSS_SALTLEN_DIGEST:j,RSA_PKCS1_PADDING:L,RSA_PSS_SALTLEN_MAX_SIGN:C,RSA_PSS_SALTLEN_AUTO:K}=e.constants;let O=e.sign;const V=e.verify,B="function"==typeof O,R=/^-----BEGIN(?: (RSA|EC))? PRIVATE KEY-----/,D=(new I(1e3),new I(1e3)),F=["HS256","HS384","HS512"],U=["RS256","RS384","RS512","PS256","PS384","PS512"],q={"1.2.840.10045.3.1.7":{bits:"256",names:["P-256","prime256v1"]},"1.3.132.0.10":{bits:"256",names:["secp256k1"]},"1.3.132.0.34":{bits:"384",names:["P-384","secp384r1"]},"1.3.132.0.35":{bits:"512",names:["P-521","secp521r1"]}};B||(O=function(t,r,o){if(void 0===t)throw new n(n.codes.signError,"EdDSA algorithms are not supported by your Node.js version.");return e.createSign(t).update(r).sign(o)});P("PrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("algorithm").seq().obj(this.key("algorithm").objid(),this.key("parameters").optional().objid()))}));const M=P("PublicKey",(function(){this.seq().obj(this.key("algorithm").seq().obj(this.key("algorithm").objid(),this.key("parameters").optional().objid()))}));P("ECPrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("privateKey").octstr(),this.key("parameters").explicit(0).optional().choice({namedCurve:this.objid()}))}));function J(e,t,r,n){return e.set(t,[r,n]),r||n}function W(e){if(!e)return"none";const[t,r]=D.get(e)||[];if(t)return t;if(r)throw r;try{if(e instanceof Buffer)e=e.toString("utf-8");else if("string"!=typeof e)throw new n(n.codes.invalidKey,"The public key must be a string or a buffer.");return J(D,e,function(e){if(e.match(R))throw new n(n.codes.invalidKey,"Private keys are not supported for verifying.");if(!e.includes("-----BEGIN PUBLIC KEY-----"))return F;const t=M.decode(e,"pem",{label:"PUBLIC KEY"}),r=t.algorithm.algorithm.join(".");let o;switch(r){case"1.2.840.113549.1.1.1":return U;case"1.2.840.10045.2.1":o=t.algorithm.parameters.join(".");break;case"1.3.101.112":case"1.3.101.113":return["EdDSA"];default:throw new n(n.codes.invalidKey,`Unsupported PEM PCKS8 public key with OID ${r}.`)}const i=q[o];if(!i)throw new n(n.codes.invalidKey,`Unsupported EC public key with curve ${o}.`);return["ES"+i.bits]}(e))}catch(t){throw J(D,e,null,n.wrap(t,n.codes.invalidKey,"Unsupported PEM public key."))}}const z=/"alg"\s*:\s*"[HERP]S(256|384)"/m,$=/"alg"\s*:\s*"EdDSA"/m,G=/"crv"\s*:\s*"Ed448"/m;function H(t){const r=t.split(".",1)[0],n=Buffer.from(r,"base64").toString("utf-8");let o=null;if(n.match($)&&n.match(G))o=e.createHash("shake256",{outputLength:114});else{const t=n.match(z);o=e.createHash("sha"+(t?t[1]:"512"))}return o.update(t).digest("hex")}function Y(e,t){const r=e[0].slice(0,2),o=t[0].slice(0,2);let i=!0;if("RS"===r||"PS"===r?i="RS"===o:"ES"!==r&&"Ed"!==r||(i=r===o),!i)throw new n(n.codes.invalidKey,`Invalid public key provided for algorithms ${e.join(", ")}.`)}function X(t,r){return"string"==typeof t&&(t=Buffer.from(t,"utf-8")),B&&(t=r?e.createSecretKey(t):e.createPublicKey(t)),t}function Q(e){return Array.isArray(e)||(e=[e]),e.map(e=>e&&"function"==typeof e.test?e:new RegExp(e.toString()))}function Z(e){const t=parseInt(!0===e?1e3:e,10);return t>0?new I(t):null}function ee({cache:e,token:t,cacheTTL:r,payload:n,ignoreExpiration:o,ignoreNotBefore:i,maxAge:a,clockTimestamp:s,clockTolerance:c},u){if(!e)return u;const l=[u,0,0];n&&"number"==typeof n.iat&&(l[1]=i||"number"!=typeof n.nbf?0:1e3*n.nbf,o||("number"==typeof n.exp?l[2]=1e3*n.exp:a&&(l[2]=1e3*n.iat+a)));const f=(s||Date.now())+c+r;return l[2]=0===l[2]?f:Math.min(l[2],f),e.set(H(t),l),u}function te(e,t,r,o){const i=r?`The ${t} claim must be a ${o} or an array of ${o}s.`:`The ${t} claim must be a ${o}.`;if(e.map(e=>typeof e).some(e=>e!==o))throw new n(n.codes.invalidClaimType,i)}function re(e,t,r,o){const i=o?`None of ${t} claim values is allowed.`:`The ${t} claim value is not allowed.`;if(!e.some(e=>r.some(t=>t.test(e))))throw new n(n.codes.invalidClaimValue,i)}function ne(e,t,r,o,i,a){const s=1e3*e+(t||0);if(!(o?r>=s:r<=s))throw new n(n.codes[i],`The token ${a} at ${new Date(s).toISOString()}.`)}function oe(t,{input:r,header:o,payload:i,signature:a},{validators:s,allowedAlgorithms:c,checkTyp:u,clockTimestamp:l,clockTolerance:f}){const h=t instanceof Buffer?t.length:!!t;if(h&&!a)throw new n(n.codes.missingSignature,"The token signature is missing.");if(!h&&a)throw new n(n.codes.missingKey,"The key option is missing.");if(function(t,r,o,i,a){if(!a.includes(r.alg))throw new n(n.codes.invalidAlgorithm,"The token algorithm is invalid.");if(o&&!function(t,r,o,i){try{const a=t.slice(0,2),s="SHA"+t.slice(2);if(i=Buffer.from(i,"base64"),"HS"===a)try{return e.timingSafeEqual(e.createHmac(s,r).update(o).digest(),i)}catch(e){return!1}else if("Ed"===a){if("function"==typeof V)return V(void 0,Buffer.from(o,"utf-8"),r,i);throw new n(n.codes.signError,"EdDSA algorithms are not supported by your Node.js version.")}const c={key:r,padding:L,saltLength:K};return"PS"===a?(c.padding=N,c.saltLength=j):"ES"===a&&(i=y.joseToDer(i,t)),e.createVerify("RSA-"+s).update(o).verify(c,i)}catch(t){throw new n(n.codes.verifyError,"Cannot verify the signature.",{originalError:t})}}(r.alg,i,t,o))throw new n(n.codes.invalidSignature,"The token signature is invalid.")}(r,o,a,t,c),u&&("string"!=typeof o.typ||u!==o.typ.toLowerCase().replace(/^application\//,"")))throw new n(n.codes.invalidType,"Invalid typ.");const p=(l||Date.now())+f;for(const e of s){const{type:t,claim:r,allowed:n,array:o,modifier:a,greater:s,errorCode:c,errorVerb:u}=e,l=i[r],f=Array.isArray(l),h=f?l:[l];r in i&&(te(h,r,o,"date"===t?"number":"string"),"date"===t?ne(l,a,p,s,c,u):re(h,r,n,f))}}function ie({key:e,allowedAlgorithms:t,complete:r,cacheTTL:o,checkTyp:i,clockTimestamp:a,clockTolerance:s,ignoreExpiration:c,ignoreNotBefore:u,maxAge:l,isAsync:f,validators:h,decode:p,cache:d},y,m){const[w,g]=f?function(e){if("function"==typeof e)return[e];let t,r;return[function(e,n){return e?r(e):t(n)},new Promise((e,n)=>{t=e,r=n})]}(m):[],b={cache:d,token:y,cacheTTL:o,payload:void 0,ignoreExpiration:c,ignoreNotBefore:u,maxAge:l,clockTimestamp:a,clockTolerance:s};if(d){const[e,t,r]=d.get(H(y))||[void 0,0,0],o=(a||Date.now())+s;if(void 0!==e&&(0===t||o>t)&&(0===r||o<=r))return function(e,t,r){if(e instanceof n){if(!t)throw e;t(e)}else{if(!t)return e;t(null,e)}return r}(e,w,g)}let v;try{v=p(y)}catch(e){if(w)return w(e),g;throw e}const{header:A,payload:T,signature:S}=v;b.payload=T;const E={validators:h,allowedAlgorithms:t,checkTyp:i,clockTimestamp:a,clockTolerance:s};if(!w)try{return oe(e,v,E),ee(b,r?{header:A,payload:T,signature:S}:T)}catch(e){throw ee(b,e)}return function(e,t,r){const n=e(t,r);n&&"function"==typeof n.then&&n.then(e=>{process.nextTick(()=>r(null,e))}).catch(r)}(e,A,(e,o)=>{if(e)return w(ee(b,n.wrap(e,n.codes.keyFetchingError,"Cannot fetch key.")));if("string"==typeof o)o=Buffer.from(o,"utf-8");else if(!(o instanceof Buffer))return w(ee(b,new n(n.codes.keyFetchingError,"The key returned from the callback must be a string or a buffer containing a secret or a public key.")));try{const e=W(o);E.allowedAlgorithms.length?Y(t,e):E.allowedAlgorithms=e,oe(o=X(o,e[0]===F[0]),v,E)}catch(e){return w(ee(b,e))}w(null,ee(b,r?{header:A,payload:T,signature:S}:T))}),g}Array.from(new Set([...F,"ES256","ES384","ES512",...U,"EdDSA","none"])).join(", ");class ae extends Error{constructor(e,t){super(t),this.code=e,this.name=this.constructor.name,this.code=e}}class se extends ae{constructor(e){super(401,"Revoked token, reason: "+e),this.reason=e,this.reason=e}}class ce extends ae{constructor(e){super(401,"Invalid token, reason: "+e),this.reason=e,this.reason=e}}class ue extends ce{constructor(e,t){super(void 0!==e?"token must be of type '"+e+(void 0!==t?.typ?`' but is of type '${t.typ}.`:"."):"token must be a string or a buffer."),this.typ=e}}class le extends ce{constructor(){super("token is malformed.")}}class fe extends ce{constructor(){super("token payload must be an object.")}}class he extends ce{constructor(){super("token signature is invalid.")}}class pe extends ce{constructor(e){super(e.toLowerCase()),this.reason=e}}class de extends ae{constructor(){super(401,"Credentials bad scheme")}}class ye extends ae{constructor(){super(401,"Credentials bad format")}}class me extends ae{constructor(){super(401,"Credentials required")}}class we extends ce{constructor(e){super(e.toLowerCase()),this.reason=e}}class ge extends ae{constructor(e){super(401,e.toLowerCase()),this.reason=e,this.reason=e}}var be=function(e,t,r){"string"==typeof t&&(t=t.split("."));"symbol"==typeof t&&(t=[t]);var n,o=t.pop();if(!o)return!1;for(;n=t.shift();)if(void 0===e[n]&&(e[n]={}),!(e=e[n])||"object"!=typeof e)return!1;return e[o]=r,!0};const ve=/^Bearer$/i;function Ae(e){if("string"==typeof e||e instanceof Buffer)return function(e){return{type:"promise",content:(t,r)=>new Promise(t=>{t(e.content)})}}({type:"basic",content:e});if(e instanceof Promise||"AsyncFunction"===e.constructor.name||"GeneratorFunction"===e.constructor.name)return{type:"promise",content:e};if("function"==typeof e&&4===e.length)return t={type:"callback",content:e},{type:"promise",content:(e,r,n)=>new Promise((o,i)=>t.content(e,r,n,(e,t)=>e?i(e):t?o(t):i(new Error("secret couldn't be retrieved"))))};throw new Error("jwt: secret field can be of type: string | Buffer | Promise | Function(req, jwtheader, payload, cb(err, ?secret))");var t}exports.JWT=e=>{if(!e||0===Object.keys(e).length)throw new Error("options can't be missing or empty, has required fields: [secret, algorithms]");if(!e.algorithms)throw new Error("jwt: algorithms field can't be undefined, must be an array of type string: [string]");if(!Array.isArray(e.algorithms))throw new Error("jwt: algorithms field must be an array of type string: [string]");const t=e.userProperty||e.requestProperty||"user",r=e.resultProperty,o=null==e.credentialsRequired||e.credentialsRequired,a=Ae(e.secret);let s=null!=e.get_token;return async(c,u,l)=>{try{let f="";if("OPTIONS"===c.method&&c.headers.hasOwnProperty("access-control-request-headers")&&(e=>(e.headers["access-control-request-headers"]||"").split(",").map(e=>e.trim()).includes("authorization"))(c))return l();if(s)f=e.get_token(c);else if(c.headers&&c.headers.authorization){const e=c.headers&&c.headers.authorization.split(" ");if(2!==e.length)throw new ye;{const t=e[0],r=e[1];if(!ve.test(t)){if(o)throw new de;return l()}f=r}}if(!f){if(o)throw new me;return l()}let h=i({complete:!0})(f,{checkTyp:e.token_type});const p=function(e){let{key:t,algorithms:r,complete:o,cache:a,cacheTTL:s,checkTyp:c,clockTimestamp:u,clockTolerance:l,ignoreExpiration:f,ignoreNotBefore:h,maxAge:p,allowedJti:d,allowedAud:y,allowedIss:m,allowedSub:w,allowedNonce:g}={cacheTTL:6e5,...e};Array.isArray(r)||(r=[]);const b=typeof t;if("string"!==b&&"object"!==b&&"function"!==b)throw new n(n.codes.INVALID_OPTION,"The key option must be a string, a buffer or a function returning the algorithm secret or public key.");if(t&&"function"!==b){const e=W(t);r.length?Y(r,e):r=e,t=X(t,e[0]===F[0])}if(u&&("number"!=typeof u||u<0))throw new n(n.codes.invalidOption,"The clockTimestamp option must be a positive number.");if(l&&("number"!=typeof l||l<0))throw new n(n.codes.invalidOption,"The clockTolerance option must be a positive number.");if(l=0,s&&("number"!=typeof s||s<0))throw new n(n.codes.invalidOption,"The cacheTTL option must be a positive number.");const v=[];h||v.push({type:"date",claim:"nbf",errorCode:"inactive",errorVerb:"will be active",greater:!0}),f||v.push({type:"date",claim:"exp",errorCode:"expired",errorVerb:"has expired"}),"number"==typeof p&&v.push({type:"date",claim:"iat",errorCode:"expired",errorVerb:"has expired",modifier:p}),d&&v.push({type:"string",claim:"jti",allowed:Q(d)}),y&&v.push({type:"string",claim:"aud",allowed:Q(y),array:!0}),m&&v.push({type:"string",claim:"iss",allowed:Q(m)}),w&&v.push({type:"string",claim:"sub",allowed:Q(w)}),g&&v.push({type:"string",claim:"nonce",allowed:Q(g)});let A=null;c&&(A=c.toLowerCase().replace(/^application\//,""));const T={key:t,allowedAlgorithms:r,complete:o,cacheTTL:s,checkTyp:A,clockTimestamp:u,clockTolerance:l,ignoreExpiration:f,ignoreNotBefore:h,maxAge:p,isAsync:"function"===b,validators:v,decode:i({complete:!0}),cache:Z(a)},S=ie.bind(null,T);return S.cache=T.cache,S}({key:async()=>await a.content(c,h.header,h.payload),complete:!0,allowedAud:e.audience,allowedIss:e.issuer}),d=await p(f);if(await((t,r)=>new Promise((n,o)=>{if(!e.is_revoked)return n(!1);e.is_revoked(t,r,(e,t)=>{if(e)return o(e);n(t)})}))(c,h.payload))throw new se("internal ruleset");r?be(u,r,d.payload):be(c,t,d.payload),l()}catch(t){switch(t.code){case n.codes.invalidType:return l(new ue(e?.token_type,t.header));case n.codes.malformed:return l(new le);case n.codes.invalidPayload:return l(new fe);case n.codes.invalidSignature:return l(new he);case n.codes.invalidClaimValue:return l(new pe(t.message));case n.codes.expired:return l(new we(t.message));case n.codes.keyFetchingError:return l(new ge(t.message));default:return l(t)}}}};
